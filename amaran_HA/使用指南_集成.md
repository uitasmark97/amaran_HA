# Amaran灯光设备Home Assistant集成使用指南

## 概述
本文档介绍如何安装、配置和使用Amaran灯光设备的Home Assistant集成。通过此集成，您可以将Amaran连接的灯光设备添加到Home Assistant中，并利用Home Assistant的界面进行控制。

## 前提条件
1. 已安装Home Assistant（建议版本2023.1或更高）
2. 已安装Amaran Desktop软件并启动
3. 已获取Amaran API密钥
4. 确保Home Assistant与Amaran设备在同一网络中

## 安装集成
1. 将`amaran`文件夹复制到Home Assistant的`custom_components`目录下
   - 通常路径为：`config/custom_components/amaran`
2. 重启Home Assistant

## 配置集成
1. 在Home Assistant界面中，进入**设置** > **设备与服务** > **集成**
2. 点击右下角的**添加集成**按钮
3. 搜索并选择**Amaran Lights**
4. 在配置页面中输入以下信息：
   - **主机地址**：Amaran Desktop运行的计算机IP地址
   - **端口**：默认12345（除非您更改了Amaran的WebSocket端口）
   - **API密钥**：您的Amaran API密钥
5. 点击**提交**，系统将尝试连接到Amaran设备
6. 连接成功后，系统将自动发现并添加灯光设备

## 设备控制
成功添加集成后，您可以在Home Assistant的**仪表盘**中找到Amaran灯光设备，并进行以下控制：

### 基本控制
- **开关**：点击设备卡片上的开关按钮可以打开或关闭灯光
- **亮度调节**：拖动亮度滑块或点击加减按钮调节亮度

### 高级控制
根据您的Amaran设备支持的功能，可能会有以下额外控制选项：

#### 色温控制（CCT）
- 如果设备支持色温调节，可以通过色温滑块选择不同的色温（单位：K）
- 色温范围取决于设备的能力，通常在2000K-10000K之间

#### 颜色控制
- **RGB模式**：通过颜色选择器直接选择RGB颜色
- **HS模式**：通过色相和饱和度滑块调节颜色

## 快照和预设
集成会自动获取Amaran设备的快照和预设信息：

### 获取ID信息

在使用`amaran.set_preset`和`amaran.set_quickshot`服务前，您需要获取设备ID、预设ID或快照ID。以下是两种获取方法：

#### 方法1：通过Home Assistant UI查看
1. 进入Home Assistant的"设备与服务"页面
2. 找到并点击您的Amaran灯光设备
3. 在设备详情页面中，滚动到"属性"部分
4. 您可以看到`device_id`和`node_id`等信息

#### 方法2：使用get_ids.py脚本
1. 确保您已安装必要的依赖（websockets和cryptography）
2. 编辑get_ids.py文件，填写您的Amaran服务器信息（host、port和api_key）
3. 在终端中运行脚本：
   ```
   python get_ids.py
   ```
4. 脚本将输出所有设备、快照和预设的ID信息

### 快照（Quickshots）
快照是设备状态的快速保存，可以通过以下方式使用：
1. 在Home Assistant中创建自动化或脚本
2. 使用"调用服务"操作，选择`amaran.set_quickshot`服务
3. 指定以下参数：
   - `quickshot_id`（快照ID）：可在集成页面查看或通过`get_quickshot_list` API获取
   - `device_id`（设备ID）：可在Home Assistant的设备页面查看，或在集成配置页面找到
   - 示例服务调用：
     ```yaml
     service: amaran.set_quickshot
     data:
       quickshot_id: "67890"
       device_id: "your_device_id"
     ```
   - 注意事项：确保`device_id`对应的值是有效的设备ID。

### 预设（Presets）
预设是设备的预配置状态，包括色温、颜色和光效等：
1. 在Home Assistant中创建自动化或脚本
2. 使用"调用服务"操作，选择`amaran.set_preset`服务
3. 指定以下参数：
   - `preset_id`（预设ID）：可在集成页面查看或通过`get_preset_list` API获取
   - `device_id`（设备ID）：可在Home Assistant的设备页面查看，或在集成配置页面找到
   - 示例服务调用：
     ```yaml
     service: amaran.set_preset
     data:
       preset_id: "12345"
       device_id: "your_device_id"
     ```
   - 注意事项：确保`device_id`对应的值是有效的设备ID，而不是节点ID或其他标识符。

## 常见问题
### 1. 无法连接到Amaran设备
- 检查Amaran Desktop是否已启动
- 确认主机地址和端口是否正确
- 确保API密钥有效
- 检查网络连接是否正常

### 2. 设备未被发现
- 确保设备已在Amaran Desktop中添加并在线
- 尝试重启Home Assistant和Amaran Desktop

### 3. 控制功能有限
- 集成会根据设备实际能力显示可用的控制选项
- 检查设备是否支持相应的功能（如RGB、CCT等）

## 高级使用
### 创建自动化
您可以利用Home Assistant的自动化功能，根据时间、事件或其他条件自动控制Amaran灯光：

示例：晚上7点自动打开灯光并设置为暖色调
```yaml
automation:
  - alias: '晚上自动开灯'
    trigger:
      platform: time
      at: '19:00:00'
    action:
      - service: light.turn_on
        target:
          entity_id: light.amaran_mc_pro_1
        data:
          color_temp: 333 # 3000K
          brightness: 200
```

### 使用场景
您可以将Amaran灯光与其他Home Assistant设备结合，创建丰富的场景：

示例：电影模式（关闭主灯，打开背景灯）
```yaml
scene:
  - name: '电影模式'
    entities:
      light.amaran_mc_pro_1:
        state: off
      light.amaran_mc_2:
        state: on
        brightness: 100
        color_temp: 200 # 5000K
```

## 更新集成
1. 下载最新版本的`amaran`文件夹
2. 替换Home Assistant`custom_components`目录下的旧版本
3. 重启Home Assistant

## 联系方式
如有任何问题或建议，请联系开发者。